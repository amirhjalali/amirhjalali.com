name: Generate AI Article

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Article topic (optional, random if not specified)'
        required: false
        type: string
  schedule:
    - cron: '0 9 * * *'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate AI article
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TOPIC: ${{ github.event.inputs.topic }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ] && [ -z "$OPENAI_API_KEY" ]; then
            echo "Error: No API keys configured. Please set ANTHROPIC_API_KEY or OPENAI_API_KEY in GitHub Secrets."
            exit 1
          fi

          if [ -n "$TOPIC" ]; then
            node scripts/generate-article-static.js "$TOPIC"
          else
            node scripts/generate-article-static.js
          fi

      - name: Configure Git
        run: |
          git config user.name "Amir H. Jalali"
          git config user.email "amirhjalali@gmail.com"

      - name: Commit and push changes
        run: |
          git add public/data/drafts.json
          git add public/images/thoughts/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: Add AI-generated article draft - Generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            git push
            echo "âœ… Article generated and committed successfully"
          fi

      - name: Trigger deployment
        run: |
          echo "Deployment will be triggered automatically by the push"
          echo "Check the 'Deploy to GitHub Pages' workflow for deployment status"

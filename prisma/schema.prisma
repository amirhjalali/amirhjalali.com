generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Article {
  id          String             @id @default(cuid())
  title       String
  slug        String             @unique
  excerpt     String
  content     String
  author      String             @default("Amir H. Jalali")
  tags        String[]
  imageUrl    String?
  readTime    String
  metadata    Json?
  aiGenerated Boolean            @default(false)
  published   Boolean            @default(false)
  featured    Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  publishedAt DateTime?
  versions    ArticleVersion[]
  noteRefs    NoteArticleRef[]

  @@index([published, publishedAt])
  @@index([slug])
}

model ArticleVersion {
  id            String   @id @default(cuid())
  articleId     String
  title         String
  content       String
  excerpt       String
  versionNumber Int
  createdAt     DateTime @default(now())
  createdBy     String   @default("system")
  changeNote    String?
  article       Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId, versionNumber])
}

model Draft {
  id          String   @id @default(cuid())
  title       String
  content     String
  excerpt     String?
  tags        String[]
  imageUrl    String?
  aiGenerated Boolean  @default(false)
  readTime    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Notes Feature Models
enum NoteType {
  LINK
  TEXT
  IMAGE
  VIDEO
  PDF
  DOCUMENT
}

enum ProcessStatus {
  PENDING
  PROCESSING
  INDEXED     // Content has been chunked and embedded
  COMPLETED
  FAILED
}

// Notebook for organizing notes into collections
model Notebook {
  id          String   @id @default(cuid())
  title       String
  description String?
  color       String?  // Hex color for UI
  icon        String?  // Emoji or icon name

  // Stats
  noteCount   Int      @default(0)

  // Relationships
  notes       Note[]
  chats       NoteChat[]

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([updatedAt])
}

model Note {
  id            String        @id @default(cuid())

  // Core content
  type          NoteType
  content       String        // URL for links/media, text for notes
  title         String?

  // Source info
  sourceUrl     String?       // Original URL for links
  sourceType    String?       // website, youtube, pdf, etc.
  domain        String?       // Extracted domain for links
  favicon       String?       // Website favicon

  // Rich content
  imageUrl      String?       // Thumbnail or base64 image
  videoUrl      String?
  excerpt       String?       // AI-generated summary

  // Full extracted content (for RAG)
  fullContent   String?       // Full extracted text content
  contentHash   String?       // Hash to detect duplicates
  wordCount     Int?

  // Metadata
  metadata      Json?         // URL metadata, video info, etc.

  // Organization
  tags          String[]
  topics        String[]      // AI-extracted topics
  notebookId    String?
  notebook      Notebook?     @relation(fields: [notebookId], references: [id], onDelete: SetNull)

  // Pinned/favorites
  pinned        Boolean       @default(false)
  starred       Boolean       @default(false)

  // Processing
  processStatus ProcessStatus @default(PENDING)
  processedAt   DateTime?
  processingError String?     // Error message if failed

  // AI Analysis
  summary       String?       // AI-generated summary
  keyInsights   String[]      // AI-extracted points
  sentiment     String?       // Positive/Neutral/Negative

  // Reading estimate
  readingTime   Int?          // Estimated reading time in minutes

  // Spaced repetition for active recall
  lastReviewedAt  DateTime?   // When was this note last reviewed
  nextReviewAt    DateTime?   // When should it be reviewed next
  reviewCount     Int         @default(0)  // Number of times reviewed
  easeFactor      Float       @default(2.5) // SM-2 algorithm ease factor
  interval        Int         @default(0)   // Current interval in days

  // Relationships
  articleRefs   NoteArticleRef[]
  chunks        NoteChunk[]

  // Knowledge graph relationships
  noteTopics    NoteTopic[]   // Topics extracted/assigned to this note
  linkedTo      NoteLink[]    @relation("LinkedFrom") // Notes this note links to
  linkedFrom    NoteLink[]    @relation("LinkedTo")   // Notes linking to this note

  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([processStatus, createdAt])
  @@index([type, createdAt])
  @@index([createdAt])
  @@index([notebookId])
  @@index([pinned, createdAt])
  @@index([starred, createdAt])
  @@index([contentHash])
  @@index([nextReviewAt])
}

// Chunks for RAG - breaking content into searchable pieces
model NoteChunk {
  id          String   @id @default(cuid())
  noteId      String
  note        Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  // Chunk content
  content     String
  chunkIndex  Int      // Order within the note
  startOffset Int?     // Character offset in original content
  endOffset   Int?

  // Metadata
  tokenCount  Int?
  metadata    Json?

  // Embedding
  embedding   Float[]  // Vector embedding for semantic search
  embeddingModel String? // Model used for embedding

  createdAt   DateTime @default(now())

  @@index([noteId, chunkIndex])
}

// Chat sessions for Q&A over notes
model NoteChat {
  id          String   @id @default(cuid())

  // Organization
  title       String?
  notebookId  String?
  notebook    Notebook? @relation(fields: [notebookId], references: [id], onDelete: SetNull)

  // Chat history stored as JSON array
  messages    Json     @default("[]")

  // Stats
  messageCount Int     @default(0)

  // Status
  status      String   @default("active") // active, archived

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([notebookId, updatedAt])
  @@index([updatedAt])
}

model NoteArticleRef {
  id        String   @id @default(cuid())
  noteId    String
  articleId String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([noteId, articleId])
  @@index([noteId])
  @@index([articleId])
}

// Knowledge Graph: Topic entity for connecting related notes
model Topic {
  id          String      @id @default(cuid())
  name        String      @unique  // Lowercase, normalized topic name
  displayName String?     // Human-readable display name

  // Stats
  noteCount   Int         @default(0)  // Number of notes with this topic

  // Topic relationships (for topic clusters)
  relatedTo   TopicRelation[] @relation("TopicFrom")
  relatedFrom TopicRelation[] @relation("TopicTo")

  // Notes with this topic
  noteTopics  NoteTopic[]

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([name])
  @@index([noteCount])
}

// Many-to-many: Notes to Topics
model NoteTopic {
  id        String   @id @default(cuid())
  noteId    String
  topicId   String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  // How strong is the association (1-10)
  relevance Float    @default(1.0)

  // Was this auto-extracted or manually added?
  autoExtracted Boolean @default(true)

  createdAt DateTime @default(now())

  @@unique([noteId, topicId])
  @@index([noteId])
  @@index([topicId])
}

// Topic-to-Topic relationships for knowledge clustering
model TopicRelation {
  id            String   @id @default(cuid())
  fromTopicId   String
  toTopicId     String
  fromTopic     Topic    @relation("TopicFrom", fields: [fromTopicId], references: [id], onDelete: Cascade)
  toTopic       Topic    @relation("TopicTo", fields: [toTopicId], references: [id], onDelete: Cascade)

  // Relationship strength (co-occurrence count or weight)
  strength      Float    @default(1.0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([fromTopicId, toTopicId])
  @@index([fromTopicId])
  @@index([toTopicId])
}

// Note-to-Note links for manual connections
model NoteLink {
  id          String   @id @default(cuid())
  fromNoteId  String
  toNoteId    String
  fromNote    Note     @relation("LinkedFrom", fields: [fromNoteId], references: [id], onDelete: Cascade)
  toNote      Note     @relation("LinkedTo", fields: [toNoteId], references: [id], onDelete: Cascade)

  // Link type: related, reference, duplicate, etc.
  linkType    String   @default("related")

  // Optional description of the link
  description String?

  // Was this auto-detected or manually created?
  autoLinked  Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@unique([fromNoteId, toNoteId])
  @@index([fromNoteId])
  @@index([toNoteId])
  @@index([linkType])
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Article {
  id          String             @id @default(cuid())
  title       String
  slug        String             @unique
  excerpt     String
  content     String
  author      String             @default("Amir H. Jalali")
  tags        String[]
  imageUrl    String?
  readTime    String
  metadata    Json?
  aiGenerated Boolean            @default(false)
  published   Boolean            @default(false)
  featured    Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  publishedAt DateTime?
  versions    ArticleVersion[]
  noteRefs    NoteArticleRef[]

  @@index([published, publishedAt])
  @@index([slug])
}

model ArticleVersion {
  id            String   @id @default(cuid())
  articleId     String
  title         String
  content       String
  excerpt       String
  versionNumber Int
  createdAt     DateTime @default(now())
  createdBy     String   @default("system")
  changeNote    String?
  article       Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId, versionNumber])
}

model Draft {
  id          String   @id @default(cuid())
  title       String
  content     String
  excerpt     String?
  tags        String[]
  imageUrl    String?
  aiGenerated Boolean  @default(false)
  readTime    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Notes Feature Models
enum NoteType {
  LINK
  TEXT
  IMAGE
  VIDEO
  PDF
  DOCUMENT
}

enum ProcessStatus {
  PENDING
  PROCESSING
  INDEXED     // Content has been chunked and embedded
  COMPLETED
  FAILED
}

// Notebook for organizing notes into collections
model Notebook {
  id          String   @id @default(cuid())
  title       String
  description String?
  color       String?  // Hex color for UI
  icon        String?  // Emoji or icon name

  // Stats
  noteCount   Int      @default(0)

  // Relationships
  notes       Note[]
  chats       NoteChat[]

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([updatedAt])
}

model Note {
  id            String        @id @default(cuid())

  // Core content
  type          NoteType
  content       String        // URL for links/media, text for notes
  title         String?

  // Source info
  sourceUrl     String?       // Original URL for links
  sourceType    String?       // website, youtube, pdf, etc.
  domain        String?       // Extracted domain for links
  favicon       String?       // Website favicon

  // Rich content
  imageUrl      String?       // Thumbnail or base64 image
  videoUrl      String?
  excerpt       String?       // AI-generated summary

  // Full extracted content (for RAG)
  fullContent   String?       // Full extracted text content
  contentHash   String?       // Hash to detect duplicates
  wordCount     Int?

  // Metadata
  metadata      Json?         // URL metadata, video info, etc.

  // Organization
  tags          String[]
  topics        String[]      // AI-extracted topics
  notebookId    String?
  notebook      Notebook?     @relation(fields: [notebookId], references: [id], onDelete: SetNull)

  // Pinned/favorites
  pinned        Boolean       @default(false)
  starred       Boolean       @default(false)

  // Processing
  processStatus ProcessStatus @default(PENDING)
  processedAt   DateTime?
  processingError String?     // Error message if failed

  // AI Analysis
  summary       String?       // AI-generated summary
  keyInsights   String[]      // AI-extracted points
  sentiment     String?       // Positive/Neutral/Negative

  // Reading estimate
  readingTime   Int?          // Estimated reading time in minutes

  // Relationships
  articleRefs   NoteArticleRef[]
  chunks        NoteChunk[]

  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([processStatus, createdAt])
  @@index([type, createdAt])
  @@index([createdAt])
  @@index([notebookId])
  @@index([pinned, createdAt])
  @@index([starred, createdAt])
  @@index([contentHash])
}

// Chunks for RAG - breaking content into searchable pieces
model NoteChunk {
  id          String   @id @default(cuid())
  noteId      String
  note        Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  // Chunk content
  content     String
  chunkIndex  Int      // Order within the note
  startOffset Int?     // Character offset in original content
  endOffset   Int?

  // Metadata
  tokenCount  Int?
  metadata    Json?

  // Embedding
  embedding   Float[]  // Vector embedding for semantic search
  embeddingModel String? // Model used for embedding

  createdAt   DateTime @default(now())

  @@index([noteId, chunkIndex])
}

// Chat sessions for Q&A over notes
model NoteChat {
  id          String   @id @default(cuid())

  // Organization
  title       String?
  notebookId  String?
  notebook    Notebook? @relation(fields: [notebookId], references: [id], onDelete: SetNull)

  // Chat history stored as JSON array
  messages    Json     @default("[]")

  // Stats
  messageCount Int     @default(0)

  // Status
  status      String   @default("active") // active, archived

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([notebookId, updatedAt])
  @@index([updatedAt])
}

model NoteArticleRef {
  id        String   @id @default(cuid())
  noteId    String
  articleId String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([noteId, articleId])
  @@index([noteId])
  @@index([articleId])
}
